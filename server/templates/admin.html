{% extends "base.html" %}{% block content %}<div class="container"><div class="d-flex justify-content-between align-items-center mb-4"><h2 class="fw-bold"><i class="fas fa-crown me-2 text-warning"></i>後台管理中心</h2><span class="badge bg-secondary">{{ current_user.role|upper }}</span></div><div class="row mb-5"><div class="col-md-4"><div class="card card-custom p-4 text-center border-start border-5 border-primary"><h5 class="text-primary fw-bold text-uppercase mb-2">總會員數</h5><h1 class="display-4 fw-bold mb-0">{{ users|length }}</h1></div></div><div class="col-md-4"><div class="card card-custom p-4 text-center border-start border-5 border-success"><h5 class="text-success fw-bold text-uppercase mb-2">軟體下載次數</h5><h1 class="display-4 fw-bold mb-0">{{ total_downloads }}</h1></div></div><div class="col-md-4"><div class="card card-custom p-4 text-center border-start border-5 border-danger"><h5 class="text-danger fw-bold text-uppercase mb-2">異常警告帳號</h5><h1 class="display-4 fw-bold mb-0">{{ flagged_count }}</h1></div></div></div><div id="announcements" class="card card-custom p-4 mb-5 border-danger" style="border-left: 5px solid #dc3545;"><h4 class="fw-bold mb-3">系統公告管理</h4><form action="{{ url_for('add_announcement') }}" method="POST" class="mb-4"><div class="row g-2 align-items-center"><div class="col-md-3"><input type="text" class="form-control" name="title" placeholder="公告標題" required></div><div class="col-md-7"><input type="text" class="form-control" name="content" placeholder="公告內容..." required></div><div class="col-md-2"><button type="submit" class="btn btn-danger w-100"><i class="fas fa-plus me-1"></i>發布</button></div></div></form><div class="table-responsive"><table class="table table-sm table-hover align-middle"><thead><tr><th>ID</th><th>日期</th><th>標題</th><th>內容摘要</th><th>操作</th></tr></thead><tbody>{% for ann in announcements %}<tr><td>{{ ann.id }}</td><td>{{ ann.created_at.strftime('%Y-%m-%d') }}</td><td>{{ ann.title }}</td><td class="text-truncate" style="max-width: 300px;">{{ ann.content }}</td><td>{% if current_user.role == 'super_admin' %}<button class="btn btn-sm btn-outline-primary me-1" data-bs-toggle="modal" data-bs-target="#editAnn{{ ann.id }}">修改</button><a href="{{ url_for('delete_announcement', ann_id=ann.id) }}" class="btn btn-sm btn-outline-danger" onclick="return confirm('確定刪除？')">刪除</a>{% else %}<span class="text-muted small">無權限</span>{% endif %}</td></tr><div class="modal fade" id="editAnn{{ ann.id }}"><div class="modal-dialog"><div class="modal-content"><form action="{{ url_for('edit_announcement', ann_id=ann.id) }}" method="POST"><div class="modal-header"><h5 class="modal-title">修改公告</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="mb-3"><label>標題</label><input type="text" class="form-control" name="title" value="{{ ann.title }}" required></div><div class="mb-3"><label>內容</label><textarea class="form-control" name="content" rows="3" required>{{ ann.content }}</textarea></div></div><div class="modal-footer"><button type="submit" class="btn btn-primary">儲存</button></div></form></div></div></div>{% endfor %}</tbody></table></div></div><div id="users" class="card card-custom p-4 mb-5"><h4 class="fw-bold mb-4 border-bottom pb-2">會員列表管理</h4><div class="table-responsive"><table class="table table-hover align-middle"><thead class="table-light"><tr><th>狀態</th><th>ID</th><th>使用者</th><th>權限</th><th>下載數</th><th>驗證次數</th><th>操作</th></tr></thead><tbody>{% for user in users %}<tr class="{{ 'table-danger' if user.is_restricted else '' }}"><td>{{ '<i class="fas fa-exclamation-triangle text-danger"></i>'|safe if user.is_restricted else '<i class="fas fa-check-circle text-success"></i>'|safe }}</td><td>{{ user.id }}</td><td><div class="d-flex align-items-center"><img src="{{ url_for('static', filename='avatars/' + user.avatar) }}" width="35" height="35" class="rounded-circle me-3"><div>{{ user.name }}<br><small class="text-muted">{{ user.email }}</small></div></div></td><td><span class="badge bg-secondary">{{ user.role }}</span></td><td>{{ user.download_count }}</td><td>{{ user.verification_attempts_total }}</td><td>{% if current_user.role == 'super_admin' %}<div class="btn-group"><button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#editUser{{ user.id }}">修改</button>{% if user.is_restricted %}<a href="{{ url_for('unflag_user', user_id=user.id) }}" class="btn btn-sm btn-success">解除</a>{% else %}<a href="{{ url_for('flag_user', user_id=user.id) }}" class="btn btn-sm btn-outline-warning">管制</a>{% endif %}<a href="{{ url_for('delete_user', user_id=user.id) }}" class="btn btn-sm btn-outline-danger" onclick="return confirm('確定刪除此使用者？')"><i class="fas fa-trash"></i></a></div>{% else %}<span class="text-muted small">僅檢視</span>{% endif %}</td></tr>{% if current_user.role == 'super_admin' %}<div class="modal fade" id="editUser{{ user.id }}"><div class="modal-dialog"><div class="modal-content"><form action="{{ url_for('admin_edit_user', user_id=user.id) }}" method="POST"><div class="modal-header"><h5 class="modal-title">修改: {{ user.name }}</h5></div><div class="modal-body"><div class="mb-3"><label>Email</label><input type="email" class="form-control" name="email" value="{{ user.email }}"></div><div class="mb-3"><label>重置密碼</label><input type="password" class="form-control" name="password" placeholder="留空則不修改"></div></div><div class="modal-footer"><button type="submit" class="btn btn-primary">儲存</button></div></form></div></div></div>{% endif %}{% endfor %}</tbody></table></div></div><div id="feedback" class="card card-custom p-4 mb-5"><h4 class="fw-bold mb-4 border-bottom pb-2">意見信箱</h4><div class="table-responsive"><table class="table table-hover"><thead class="table-light"><tr><th>日期</th><th>姓名</th><th>主旨</th><th>內容</th></tr></thead><tbody>{% for fb in feedbacks %}<tr><td style="white-space:nowrap">{{ fb.created_at.strftime('%Y-%m-%d') }}</td><td>{{ fb.name }}</td><td>{{ fb.subject }}</td><td>{{ fb.message }}</td></tr>{% endfor %}</tbody></table></div></div>{% if current_user.role == 'super_admin' %}<div id="admins" class="card card-custom p-4 mb-5 border-warning" style="border-left: 5px solid #ffc107;"><h4 class="fw-bold mb-3">新增其他管理員</h4><form action="{{ url_for('create_admin') }}" method="POST" class="row g-3"><div class="col-md-4"><input type="email" class="form-control" name="email" placeholder="Email (防呆)" required oninput="restrictInput(this)"></div><div class="col-md-4"><input type="password" class="form-control" name="password" placeholder="Password (防呆)" required oninput="restrictInput(this)"></div><div class="col-md-3"><input type="text" class="form-control" name="name" placeholder="Name" required></div><div class="col-md-1"><button type="submit" class="btn btn-warning w-100">新增</button></div></form></div>{% endif %}</div>{% endblock %}