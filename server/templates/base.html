<!DOCTYPE html>
<html lang="zh-TW" data-bs-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CR3 系統</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { background-color: #f3f6f9; font-family: 'Segoe UI', Roboto, sans-serif; transition: background-color 0.3s, color 0.3s; }
        .navbar { background-color: #ffffff !important; box-shadow: 0 4px 12px rgba(0,0,0,0.05); padding: 12px 0; }
        .navbar-brand { font-weight: 800; color: #4e73df !important; font-size: 1.4rem; }
        .main-container { max-width: 1140px; margin: 0 auto; padding: 40px 20px; }
        .card-custom { border: none; border-radius: 16px; box-shadow: 0 8px 24px rgba(0,0,0,0.06); background: #fff; overflow: hidden; margin-bottom: 30px; }
        
        [data-bs-theme="dark"] body { background-color: #121212; color: #e0e0e0; }
        [data-bs-theme="dark"] .navbar { background-color: #1e1e1e !important; border-bottom: 1px solid #333; }
        [data-bs-theme="dark"] .card-custom { background-color: #1e1e1e; color: #fff; border: 1px solid #333; }
        [data-bs-theme="dark"] .form-control { background-color: #2b2b2b; border-color: #444; color: #fff; }
        [data-bs-theme="dark"] .offcanvas { background-color: #1e1e1e; color: #fff; }
        [data-bs-theme="dark"] .btn-close { filter: invert(1); }
        [data-bs-theme="dark"] .list-group-item { background-color: #1e1e1e; color: #fff; border-color: #333; }
        [data-bs-theme="dark"] .modal-content { background-color: #1e1e1e; color: #fff; border: 1px solid #444; }

        .profile-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); height: 180px; position: relative; }
        .profile-avatar-container { position: absolute; left: 50%; transform: translate(-50%, 50%); bottom: 0; width: 140px; height: 140px; }
        .profile-avatar { width: 100%; height: 100%; border-radius: 50%; border: 5px solid #fff; object-fit: cover; background-color: #fff; }
        .avatar-edit-btn { position: absolute; bottom: 0px; right: 0px; background: #fff; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 8px rgba(0,0,0,0.3); cursor: pointer; color: #555; z-index: 20; transition: transform 0.2s; border: 2px solid #f0f2f5; }
        .avatar-edit-btn:hover { transform: scale(1.1); background-color: #f8f9fa; }

        .no-drag { user-select: none; }
        .offcanvas-header { background-color: #f8f9fa; border-bottom: 1px solid #dee2e6; }
        [data-bs-theme="dark"] .offcanvas-header { background-color: #2c2c2c; border-color: #444; }
        .cr3-logo-circle { width: 80px; height: 80px; background: linear-gradient(135deg, #4e73df, #224abe); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 900; font-size: 1.5rem; letter-spacing: 1px; margin: 0 auto 20px; box-shadow: 0 5px 15px rgba(78, 115, 223, 0.3); }
        .announcement-item { border-left: 4px solid #4e73df; background-color: rgba(78, 115, 223, 0.05); transition: transform 0.2s; }
        .announcement-item:hover { transform: translateX(5px); }
        .password-toggle-btn { cursor: pointer; border-left: none; z-index: 10; }
        .password-toggle-btn:hover { background-color: transparent; color: #4e73df; }
        .scrollable-box { max-height: 400px; overflow-y: auto; padding-right: 5px; }
        .scrollable-box::-webkit-scrollbar { width: 6px; }
        .scrollable-box::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        .scrollable-box::-webkit-scrollbar-thumb { background: #ccc; border-radius: 10px; }
        
        .upload-area { border: 2px dashed #4e73df; background-color: rgba(78, 115, 223, 0.05); transition: all 0.3s; cursor: pointer; }
        .upload-area:hover { background-color: rgba(78, 115, 223, 0.1); transform: scale(1.01); }
        .filename-text { white-space: normal !important; word-break: break-all; font-size: 0.85rem; line-height: 1.4; }
        .preview-card img { cursor: zoom-in; transition: opacity 0.2s; }
        .preview-card img:hover { opacity: 0.9; }
        .zoom-container { overflow: hidden; cursor: crosshair; position: relative; background-color: #000; }
        .zoom-container img { transition: transform 0.1s ease-out; transform-origin: center center; width: 100%; display: block; }
        
        .presentation-container { position: relative; width: 100%; padding-bottom: 56.25%; height: 0; overflow: hidden; border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); background: #000; margin-bottom: 20px; }
        .presentation-container iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 0; }
    </style>
    <script>
        function restrictInput(input) { input.value = input.value.replace(/[^a-zA-Z0-9@._-]/g, ''); }
        function togglePassword(inputId, iconId) {
            const input = document.getElementById(inputId); const icon = document.getElementById(iconId);
            if (input.type === "password") { input.type = "text"; icon.classList.remove("fa-eye"); icon.classList.add("fa-eye-slash"); } 
            else { input.type = "password"; icon.classList.remove("fa-eye-slash"); icon.classList.add("fa-eye"); }
        }
    </script>
</head>
<body>
<nav class="navbar navbar-expand-lg sticky-top">
  <div class="container">
    <a class="navbar-brand" href="{{ url_for('index') }}"><i class="fas fa-images me-2"></i>CR3 系統</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"><span class="navbar-toggler-icon"></span></button>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav ms-auto align-items-center">
        {% if current_user.is_authenticated %}
            {% if current_user.role in ['admin', 'super_admin'] %}
                <li class="nav-item"><button class="btn btn-warning btn-sm fw-bold me-3 rounded-pill px-3 shadow-sm" type="button" data-bs-toggle="offcanvas" data-bs-target="#adminOffcanvas"><i class="fas fa-tools me-1"></i>管理選單</button></li>
            {% endif %}
            <li class="nav-item me-3"><a class="nav-link fw-bold" href="{{ url_for('profile') }}"><img src="{{ url_for('static', filename='avatars/' + current_user.avatar) }}" class="rounded-circle me-1" width="32" height="32" style="object-fit: cover;">{{ current_user.name }}</a></li>
            <li class="nav-item"><a class="nav-link" href="{{ url_for('logout') }}">登出</a></li>
        {% else %}
            <li class="nav-item"><a class="nav-link" href="{{ url_for('login') }}">登入</a></li>
        {% endif %}
        <li class="nav-item"><a class="nav-link" href="{{ url_for('about') }}">關於</a></li>
        <li class="nav-item"><a class="btn btn-outline-primary btn-sm ms-2 rounded-pill px-4" href="{{ url_for('online_check') }}">線上檢查</a></li>
        {% if current_user.is_authenticated %}
            <li class="nav-item ms-2"><a class="btn btn-primary btn-sm rounded-pill px-3" href="{{ url_for('download_app') }}"><i class="fas fa-download me-1"></i>EXE</a></li>
        {% endif %}
        <li class="nav-item ms-3"><button class="btn btn-light rounded-circle shadow-sm border" id="themeToggle" style="width: 40px; height: 40px;"><i class="fas fa-sun text-warning"></i></button></li>
      </ul>
    </div>
  </div>
</nav>

<div class="offcanvas offcanvas-end" tabindex="-1" id="adminOffcanvas">
  <div class="offcanvas-header"><h5 class="offcanvas-title fw-bold"><i class="fas fa-user-shield me-2"></i>管理員中心</h5><button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas"></button></div>
  <div class="offcanvas-body">
    <div class="list-group list-group-flush">
        <a href="{{ url_for('admin_dashboard') }}" class="list-group-item list-group-item-action border-0 py-3"><i class="fas fa-tachometer-alt me-3 text-primary"></i>儀表板總覽</a>
        <a href="{{ url_for('admin_dashboard') }}#announcements" class="list-group-item list-group-item-action border-0 py-3"><i class="fas fa-bullhorn me-3 text-danger"></i>系統公告管理</a>
        <a href="{{ url_for('admin_dashboard') }}#users" class="list-group-item list-group-item-action border-0 py-3"><i class="fas fa-users me-3 text-success"></i>會員管理</a>
        <a href="{{ url_for('admin_dashboard') }}#feedback" class="list-group-item list-group-item-action border-0 py-3"><i class="fas fa-envelope me-3 text-info"></i>意見信箱</a>
        {% if current_user.role == 'super_admin' %}<a href="{{ url_for('admin_dashboard') }}#admins" class="list-group-item list-group-item-action border-0 py-3"><i class="fas fa-key me-3 text-warning"></i>新增管理員</a>{% endif %}
    </div>
    <div class="mt-5 text-center text-muted small border-top pt-3">CR3 System v30.0</div>
  </div>
</div>

<div class="container py-5">
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="row justify-content-center mb-4"><div class="col-md-8">
            {% for category, message in messages %}<div class="alert alert-{{ category }} alert-dismissible fade show shadow-sm" role="alert">{{ message }}<button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>{% endfor %}
        </div></div>
      {% endif %}
    {% endwith %}
    {% block content %}{% endblock %}
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const toggleBtn = document.getElementById('themeToggle'); const htmlEl = document.documentElement; const icon = toggleBtn.querySelector('i');
    const savedTheme = localStorage.getItem('theme') || 'light'; htmlEl.setAttribute('data-bs-theme', savedTheme); updateIcon(savedTheme);
    toggleBtn.addEventListener('click', () => { const newTheme = htmlEl.getAttribute('data-bs-theme') === 'light' ? 'dark' : 'light'; htmlEl.setAttribute('data-bs-theme', newTheme); localStorage.setItem('theme', newTheme); updateIcon(newTheme); });
    function updateIcon(theme) { if (theme === 'dark') { icon.className = 'fas fa-moon text-white'; toggleBtn.className = 'btn btn-dark border-secondary'; } else { icon.className = 'fas fa-sun text-warning'; toggleBtn.className = 'btn btn-light border'; } }
</script>
</body>
</html>